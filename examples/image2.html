<!DOCTYPE html>
<html>
<head>
  <style>
input {
  display: block; 
}
img {
  display: inline;
}
canvas {
  position: absolute;
  left: 0;
}
  </style>
  <script src="../javascript/jquery.min.js"></script>
</head>
<body>
  <input type='file' onchange="readURL(this);" />

  <!--img id="scream" src="../test1.jpg" alt="The Scream" width="220" height="277"-->

  <canvas id="myCanvas" width="300" height="300" style="border:0px solid #d3d3d3;">
    Your browser does not support the HTML5 canvas tag.
  </canvas>

  <script>
var img = new Image();
var width_sample = 10;

img.onload = function() {
  console.log(this.width, this.height);
  var c = document.getElementById("myCanvas");
  var ctx = c.getContext("2d");
  ctx.canvas.width = this.width;
  ctx.canvas.height = this.height;
  ctx.drawImage(img, 0, 0);
  var imgData = ctx.getImageData(0, 0, c.width, c.height);
  console.log(imgData);
  
    var top = 0;
    var step_w = Math.max(1, Math.floor(img.width / width_sample));
    var step_h = 1; //Math.max(1, Math.floor(img.height / height_sample));
    var th_diff = Math.min(20, step_w * 2);
    var anchor = Math.floor(img.height / 3);
    console.log(step_w, step_h);
    var stride = img.width * 4;
    for (var i = anchor; i >= 0; i -= step_h) {
      var flag = false;
      var prev_b = imgData.data[i * stride];
      var prev_g = imgData.data[i * stride + 1];
      var prev_r = imgData.data[i * stride + 2];
      var line_diff = 0;
      for (var j = 0; j < img.width; j += step_w) {
        var b = imgData.data[i * stride + j * 4];
        var g = imgData.data[i * stride + j * 4 + 1];
        var r = imgData.data[i * stride + j * 4 + 2];
        /*
        if (rgb[0] != rgb[1] || rgb[1] != rgb[2] || rgb[0] != rgb[2]) {
          flag = true;
          break;
        }*/
        var diff = Math.max(Math.abs(prev_b - b), Math.abs(prev_g - g), Math.abs(prev_r - r));
        if (diff > th_diff) {
          //console.log(i, diff);
          flag = true;
          break;
        }
        line_diff += diff;
        //if (prev[0] != rgb[0] || prev[1] != rgb[1] || prev[2] != rgb[2]) {
        if (line_diff > width_sample * 2) {
          //console.log(i, line_diff);
          flag = true;
          break;
        }
        prev_b = b;
        prev_g = g;
        prev_r = r;
      }
      if (!flag) {
        top = i+1;
        break;
      }
    }
    var bottom = img.height - 1;
    for (var i = anchor + 1; i < img.height; i += step_h) {
      var flag = false;
      var prev_b = imgData.data[i * stride];
      var prev_g = imgData.data[i * stride + 1];
      var prev_r = imgData.data[i * stride + 2];
      var line_diff = 0;
      for (var j = 0; j < img.width; j += step_w) {
        var b = imgData.data[i * stride + j * 4];
        var g = imgData.data[i * stride + j * 4 + 1];
        var r = imgData.data[i * stride + j * 4 + 2];
        /*
        if (rgb[0] != rgb[1] || rgb[1] != rgb[2] || rgb[0] != rgb[2]) {
          flag = true;
          break;
        }
        */
        var diff = Math.max(Math.abs(prev_b - b), Math.abs(prev_g - g), Math.abs(prev_r - r));
        if (diff > th_diff) {
          //console.log(i, diff);
          flag = true;
          break;
        }
        line_diff += diff;
        //if (prev[0] != rgb[0] || prev[1] != rgb[1] || prev[2] != rgb[2]) {
        if (line_diff > width_sample * 2) {
          //console.log(i, line_diff);
          flag = true;
          break;
        }
        prev_b = b;
        prev_g = g;
        prev_r = r;
      }
      if (!flag) {
        bottom = i-1;
        /*
        for (var j = 0; j < img.width; j += step_w) {
          var rgb = img.get(i-15, j);
          console.log(i, j, rgb[0], rgb[1], rgb[2]);
        }*/
        break;
      }
    }
    console.log(top, bottom);
  
  for (var i = 0; i < top; i++) {
    for (var j = 0; j < img.width; j++) {
      imgData.data[i * stride + j * 4] = 255;
      imgData.data[i * stride + j * 4 + 1] = 255;
      imgData.data[i * stride + j * 4 + 2] = 255;
    }
  }
  for (var i = bottom + 1; i < img.height; i++) {
    for (var j = 0; j < img.width; j++) {
      imgData.data[i * stride + j * 4] = 255;
      imgData.data[i * stride + j * 4 + 1] = 255;
      imgData.data[i * stride + j * 4 + 2] = 255;
    }
  }
  var imgData = ctx.getImageData(0, top, c.width, bottom - top + 1);
  ctx.canvas.height = bottom - top + 1;

  // invert colors
  /*
  for (var i = 0; i < imgData.data.length; i += 4) {
      imgData.data[i] = 255 - imgData.data[i];
      imgData.data[i + 1] = 255 - imgData.data[i + 1];
      imgData.data[i + 2] = 255 - imgData.data[i + 2];
      imgData.data[i + 3] = 255;
  }
  */
  ctx.putImageData(imgData, 0, 0);
  //window.open(ctx.canvas.toDataURL('image/png'));
  var gh = ctx.canvas.toDataURL('png');
  var a = document.createElement('a');
  a.href = gh;
  a.download = 'image.png';
  a.click();
};
/*
document.getElementById("scream").onload = function () {
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    ctx.canvas.width = this.width;
    ctx.canvas.height = this.height;
    
    var img = document.getElementById("scream");
    console.log(img);
    ctx.drawImage(img, 0, 0);
    var imgData = ctx.getImageData(0, 0, c.width, c.height);
    // invert colors
    for (var i = 0; i < imgData.data.length; i += 4) {
        imgData.data[i] = 255 - imgData.data[i];
        imgData.data[i + 1] = 255 - imgData.data[i + 1];
        imgData.data[i + 2] = 255 - imgData.data[i + 2];
        imgData.data[i + 3] = 255;
    }
    ctx.putImageData(imgData, 0, 0);
};
*/
function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            //$('#scream').attr('src', e.target.result).width(150).height(200);
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

  </script>

</body>
</html>